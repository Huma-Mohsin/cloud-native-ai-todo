# Implementation Plan: Phase III AI-Powered Chatbot

**Branch**: `003-phase-iii-chatbot` | **Date**: 2026-01-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-phase-iii-chatbot/spec.md`

**Note**: This template is filled in by the `/sp.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Transform the Todo web application into an AI-powered chatbot that allows users to manage tasks through natural language conversations. The implementation uses OpenAI Agents SDK (agent + runner pattern) with MCP (Model Context Protocol) server exposing 5 task operation tools (add_task, list_tasks, complete_task, delete_task, update_task). The architecture is stateless with database-persisted conversation state, enabling horizontal scalability. Frontend uses OpenAI ChatKit for chat UI, backend uses FastAPI with Official MCP SDK for tool definitions. All conversation history and messages persist in PostgreSQL (conversations and messages tables).

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript/Next.js 15+ (frontend)
**Primary Dependencies**: FastAPI, OpenAI Agents SDK, Official MCP SDK (Python), OpenAI ChatKit, SQLModel, Better Auth
**Storage**: Neon Serverless PostgreSQL (new tables: conversations, messages; existing: users, tasks)
**Testing**: pytest (backend unit/integration), Jest/Vitest (frontend unit), Playwright (E2E)
**Target Platform**: Web application (Next.js frontend + FastAPI backend)
**Project Type**: web (existing backend/ and frontend/ structure)
**Performance Goals**: < 2s chat response p95 (including AI processing), < 200ms MCP tool execution p95, < 100ms database queries p95
**Constraints**: Stateless server (no in-memory conversation state), database-persisted state, horizontal scalability, 512MB memory per pod, 1 CPU per pod
**Scale/Scope**: 100+ concurrent users, 1000+ messages per conversation, 10,000+ tasks per user, 5 MCP tools, 2 new database tables

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Spec-Driven Development (NON-NEGOTIABLE)
âœ… **PASS**: Following proper SDD workflow (spec.md â†’ plan.md â†’ tasks.md â†’ implementation)
âœ… **PASS**: All code will be generated by Claude Code from specifications
âœ… **PASS**: No manual coding allowed

### Progressive Evolution Architecture
âœ… **PASS**: Phase III builds on Phase II (Full-Stack Web App)
âœ… **PASS**: Adds AI chatbot layer without breaking existing functionality
âœ… **PASS**: Prepares for Phase IV (Kubernetes) and Phase V (Cloud + Events)

### Monorepo Structure (MANDATORY)
âœ… **PASS**: Using existing monorepo structure (backend/ and frontend/)
âœ… **PASS**: New code integrates into existing directories
âœ… **PASS**: No new top-level projects created

### Technology Stack Standards
âœ… **PASS**: Backend - FastAPI (approved)
âœ… **PASS**: Frontend - Next.js (approved)
âœ… **PASS**: Database - PostgreSQL (approved)
âœ… **PASS**: ORM - SQLModel (approved)
âœ… **PASS**: Authentication - Better Auth (approved)
âœ… **PASS**: AI Framework - OpenAI Agents SDK (new, Phase III requirement)
âœ… **PASS**: MCP Server - Official MCP SDK (new, Phase III requirement)
âœ… **PASS**: Chat UI - OpenAI ChatKit (new, Phase III requirement)

### Testing Standards
âœ… **PASS**: TDD approach required
âœ… **PASS**: 80%+ coverage target (spec requires 80%+ backend, 100% MCP tools)
âœ… **PASS**: Unit tests for all MCP tools
âœ… **PASS**: Integration tests for chat endpoint
âœ… **PASS**: E2E tests for conversation flows

### Code Quality Standards
âœ… **PASS**: Type safety (Pydantic models for MCP tools, TypeScript for frontend)
âœ… **PASS**: Error handling (comprehensive error cases in spec)
âœ… **PASS**: Input validation (message length limits, SQL injection prevention)
âœ… **PASS**: Documentation (API docs, architecture diagram, natural language examples)

### Authentication & Security
âœ… **PASS**: JWT authentication required for all chat endpoints
âœ… **PASS**: User isolation (users can only access own conversations/messages/tasks)
âœ… **PASS**: Input validation and sanitization
âœ… **PASS**: Secrets management (OpenAI API key, database credentials in .env)
âœ… **PASS**: Rate limiting (max 10 requests/minute per user)

### Performance & Scalability
âœ… **PASS**: Stateless architecture enables horizontal scaling
âœ… **PASS**: Database-persisted state (no in-memory state)
âœ… **PASS**: Performance targets defined (< 2s chat response)
âœ… **PASS**: Resource limits specified (512MB memory, 1 CPU per pod)

### Database Standards
âœ… **PASS**: Migration-based schema changes (003_add_chat_tables.sql)
âœ… **PASS**: Foreign key constraints (conversations â†’ users, messages â†’ conversations/users)
âœ… **PASS**: Indexes on foreign keys (idx_conversations_user_id, idx_messages_conversation_id)
âœ… **PASS**: Timestamp tracking (created_at, updated_at)

**GATE RESULT**: âœ… **ALL CHECKS PASSED** - Proceed to Phase 0 research

## Project Structure

### Documentation (this feature)

```text
specs/003-phase-iii-chatbot/
â”œâ”€â”€ plan.md              # This file (/sp.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/sp.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/sp.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/sp.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/sp.plan command)
â”‚   â””â”€â”€ chat-api.yaml    # OpenAPI spec for chat endpoint
â””â”€â”€ tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ conversation.py      # NEW: Conversation SQLModel
â”‚   â”‚   â”œâ”€â”€ message.py           # NEW: Message SQLModel
â”‚   â”‚   â””â”€â”€ task.py              # EXISTING: Task model (no changes)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ chat_service.py      # NEW: Chat endpoint logic
â”‚   â”‚   â””â”€â”€ agent_service.py     # NEW: OpenAI Agents SDK integration
â”‚   â”œâ”€â”€ mcp/
â”‚   â”‚   â”œâ”€â”€ __init__.py          # NEW: MCP server initialization
â”‚   â”‚   â”œâ”€â”€ server.py            # NEW: MCP server with Official SDK
â”‚   â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”‚   â”œâ”€â”€ add_task.py      # NEW: add_task MCP tool
â”‚   â”‚   â”‚   â”œâ”€â”€ list_tasks.py    # NEW: list_tasks MCP tool
â”‚   â”‚   â”‚   â”œâ”€â”€ complete_task.py # NEW: complete_task MCP tool
â”‚   â”‚   â”‚   â”œâ”€â”€ delete_task.py   # NEW: delete_task MCP tool
â”‚   â”‚   â”‚   â””â”€â”€ update_task.py   # NEW: update_task MCP tool
â”‚   â”‚   â””â”€â”€ schemas.py           # NEW: Pydantic schemas for MCP tools
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ routes/
â”‚           â””â”€â”€ chat.py          # NEW: POST /api/{user_id}/chat endpoint
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 003_add_chat_tables.sql  # NEW: conversations and messages tables
â””â”€â”€ tests/
    â”œâ”€â”€ unit/
    â”‚   â”œâ”€â”€ test_mcp_tools.py    # NEW: Unit tests for all 5 MCP tools
    â”‚   â”œâ”€â”€ test_conversation.py # NEW: Conversation model tests
    â”‚   â””â”€â”€ test_message.py      # NEW: Message model tests
    â”œâ”€â”€ integration/
    â”‚   â”œâ”€â”€ test_chat_endpoint.py # NEW: Chat endpoint integration tests
    â”‚   â””â”€â”€ test_agent_mcp.py    # NEW: Agent + MCP integration tests
    â””â”€â”€ e2e/
        â””â”€â”€ test_chat_flows.py   # NEW: E2E conversation flow tests

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ chat/
â”‚   â”‚       â”œâ”€â”€ ChatInterface.tsx # NEW: OpenAI ChatKit wrapper
â”‚   â”‚       â””â”€â”€ ChatMessage.tsx   # NEW: Message display component
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â””â”€â”€ chat.tsx             # NEW: Chat page
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ chatService.ts       # NEW: Chat API client
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ useChat.ts           # NEW: Chat state management hook
â””â”€â”€ tests/
    â””â”€â”€ unit/
        â””â”€â”€ chat/
            â”œâ”€â”€ ChatInterface.test.tsx # NEW: ChatKit component tests
            â””â”€â”€ chatService.test.ts    # NEW: Chat service tests
```

**Structure Decision**: Web application structure (Option 2) selected. This feature adds AI chatbot capabilities to the existing Full-Stack Web App (Phase II). Backend adds MCP server with 5 tools, chat service, and agent integration. Frontend adds OpenAI ChatKit-based chat interface. Database adds 2 new tables (conversations, messages) with proper foreign keys and indexes. All new code integrates into existing backend/ and frontend/ directories following monorepo standards.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No violations detected.** All constitution checks passed. No complexity tracking required.

---

## Phase 0: Research & Clarification

**Status**: Pending
**Output**: `research.md`

### Research Tasks

1. **OpenAI Agents SDK + MCP Integration Pattern**
   - Research: How to integrate OpenAI Agents SDK with MCP server tools
   - Question: What's the best pattern for agent + runner + MCP tools?
   - Question: How to pass conversation history to agent?
   - Question: How to handle tool call results in agent responses?

2. **Official MCP SDK (Python) Best Practices**
   - Research: MCP server initialization and tool registration
   - Research: Tool schema definition with Pydantic
   - Research: Error handling in MCP tools
   - Research: Testing MCP tools in isolation

3. **OpenAI ChatKit Configuration**
   - Research: ChatKit setup with Next.js
   - Research: Domain allowlist configuration for production
   - Research: Authentication integration (JWT tokens)
   - Research: Custom styling and branding

4. **Stateless Chat Architecture**
   - Research: Best practices for stateless conversation handling
   - Research: Database query optimization for conversation history
   - Research: Pagination strategies for long conversations
   - Research: Caching strategies for conversation context

5. **Natural Language Understanding Patterns**
   - Research: Agent instruction design for task management
   - Research: Handling ambiguous user inputs
   - Research: Multi-step tool call patterns (search then action)
   - Research: Error recovery and fallback responses

### Clarifications Needed

**None at this time.** Spec is comprehensive with clear requirements, API specifications, MCP tool definitions, database schema, and acceptance criteria.

---

## Phase 1: Design & Contracts

**Status**: Pending
**Output**: `data-model.md`, `contracts/chat-api.yaml`, `quickstart.md`

### Data Model Design

**New Entities:**

1. **Conversation**
   - Fields: id, user_id, created_at, updated_at
   - Relationships: belongs_to User, has_many Messages
   - Indexes: user_id

2. **Message**
   - Fields: id, conversation_id, user_id, role, content, created_at
   - Relationships: belongs_to Conversation, belongs_to User
   - Indexes: conversation_id, user_id
   - Validation: role in ('user', 'assistant')

**Existing Entities (No Changes):**
- User (managed by Better Auth)
- Task (from Phase II)

### API Contracts

**Chat Endpoint:**
- Method: POST
- Path: /api/{user_id}/chat
- Authentication: JWT token required
- Request: { conversation_id?: number, message: string }
- Response: { conversation_id: number, response: string, tool_calls: array }
- Status Codes: 200, 400, 401, 403, 500

**MCP Tools (Internal):**
- add_task(user_id, title, description?)
- list_tasks(user_id, status?)
- complete_task(user_id, task_id)
- delete_task(user_id, task_id)
- update_task(user_id, task_id, title?, description?)

### Agent Context Update

After Phase 1 design completion, run:
```bash
.specify/scripts/bash/update-agent-context.sh claude
```

This will update `.claude/context.md` with Phase III technologies:
- OpenAI Agents SDK
- Official MCP SDK
- OpenAI ChatKit

---

## Phase 2: Task Generation

**Status**: Pending
**Command**: `/sp.tasks 003-phase-iii-chatbot`
**Output**: `tasks.md`

**Note**: Phase 2 is NOT part of `/sp.plan` command. After completing Phase 0 and Phase 1, user must run `/sp.tasks` separately to generate implementation tasks.

---

## Implementation Notes

### Key Architectural Decisions

1. **Stateless Server Architecture**
   - **Decision**: Server holds no in-memory conversation state
   - **Rationale**: Enables horizontal scaling, resilience to restarts, load balancing
   - **Implementation**: Fetch conversation history from database on each request

2. **Database-Persisted Conversations**
   - **Decision**: Store all messages in PostgreSQL
   - **Rationale**: Persistence across sessions, user can resume conversations
   - **Implementation**: conversations and messages tables with foreign keys

3. **MCP Server with Official SDK**
   - **Decision**: Use Official MCP SDK (Python) for tool definitions
   - **Rationale**: Standard protocol, type-safe schemas, better tooling
   - **Implementation**: 5 tools exposing task operations to AI agent

4. **OpenAI Agents SDK (Agent + Runner Pattern)**
   - **Decision**: Use OpenAI Agents SDK for AI logic
   - **Rationale**: Official framework, handles tool calling, conversation management
   - **Implementation**: Agent with MCP tools, runner executes agent with history

5. **OpenAI ChatKit for Frontend**
   - **Decision**: Use OpenAI ChatKit for chat UI
   - **Rationale**: Pre-built, production-ready, handles message rendering
   - **Implementation**: ChatKit component with custom API integration

### Performance Optimizations

1. **Conversation History Limiting**
   - Fetch only last 50 messages per conversation
   - Prevents performance degradation on long conversations
   - Implement pagination if user needs older messages

2. **Database Indexing**
   - Index on conversations.user_id (user's conversations)
   - Index on messages.conversation_id (conversation's messages)
   - Index on messages.user_id (user's messages)

3. **Connection Pooling**
   - Max 10 database connections per backend pod
   - Prevents connection exhaustion under load

4. **Rate Limiting**
   - Max 10 chat requests per minute per user
   - Prevents API abuse and OpenAI rate limit issues

### Security Considerations

1. **Authentication**: JWT token required for all chat endpoints
2. **Authorization**: user_id in token must match {user_id} in URL path
3. **Data Isolation**: All queries filter by authenticated user's ID
4. **Input Validation**: Message length limit (2000 chars), SQL injection prevention
5. **Secrets Management**: OpenAI API key, database credentials in .env (gitignored)

### Testing Strategy

1. **Unit Tests**: All MCP tools (100% coverage), database models
2. **Integration Tests**: Chat endpoint, agent + MCP integration
3. **E2E Tests**: Full conversation flows (create, list, complete, delete, update tasks)
4. **Coverage Target**: 80%+ backend, 100% MCP tools

### Deployment Considerations

1. **Database Migration**: Run 003_add_chat_tables.sql before deployment
2. **Environment Variables**: OPENAI_API_KEY, DATABASE_URL, BETTER_AUTH_SECRET
3. **OpenAI Domain Allowlist**: Configure production domain in OpenAI settings
4. **Health Checks**: Add /health endpoint for Kubernetes readiness probes

---

## Risks and Mitigations

### Risk 1: OpenAI API Rate Limits
**Impact**: High | **Probability**: Medium
**Mitigation**: Request queuing, retry with exponential backoff, usage monitoring

### Risk 2: Conversation History Performance
**Impact**: Medium | **Probability**: Low
**Mitigation**: Limit to last 50 messages, pagination, database indexing

### Risk 3: Natural Language Understanding Accuracy
**Impact**: Medium | **Probability**: Medium
**Mitigation**: Clear agent instructions, diverse testing, fallback responses

### Risk 4: OpenAI ChatKit Domain Allowlist
**Impact**: High | **Probability**: Low
**Mitigation**: Configure early, test on production domain, backup plan (custom UI)

---

## Success Criteria

### Functional
- âœ… User can create tasks via natural language
- âœ… User can list tasks via natural language
- âœ… User can complete tasks via natural language
- âœ… User can delete tasks via natural language
- âœ… User can update tasks via natural language
- âœ… Conversations persist across sessions
- âœ… Server is stateless (no in-memory state)
- âœ… Errors are handled gracefully

### Technical
- âœ… All 5 MCP tools implemented and tested
- âœ… Chat endpoint is stateless
- âœ… Conversation state persists in database
- âœ… Authentication and authorization working
- âœ… 80%+ test coverage
- âœ… Response times meet requirements (< 2s chat, < 200ms tools)

### Quality
- âœ… Code follows constitution standards
- âœ… All tests passing
- âœ… No security vulnerabilities
- âœ… Documentation complete
- âœ… Demo video under 90 seconds

---

## Next Steps

1. **Complete Phase 0**: Generate `research.md` with OpenAI Agents SDK + MCP integration patterns
2. **Complete Phase 1**: Generate `data-model.md`, `contracts/chat-api.yaml`, `quickstart.md`
3. **Update Agent Context**: Run `.specify/scripts/bash/update-agent-context.sh claude`
4. **Generate Tasks**: Run `/sp.tasks 003-phase-iii-chatbot` to create `tasks.md`
5. **Implement**: Run `/sp.implement` to execute tasks and generate code
6. **Test**: Run test suite and verify 80%+ coverage
7. **Deploy**: Apply migrations, deploy backend/frontend, configure OpenAI domain
8. **Demo**: Record 90-second demo video

---

**Status**: Plan Complete - Ready for Phase 0 Research
**Estimated Effort**: 15-20 hours (with custom skills: `/sp.mcp-gen`, `/sp.test-suite`)
**Points**: 200 (Phase III completion)

---

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
